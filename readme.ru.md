## Подключение FMC устройств для MikoPBX

Читайте на других языках: [English](README.md), [Русский](readme.ru.md)

### Назначение
Модуль подключает FMC SIM‑карты к MikoPBX, эмулируя SIP‑телефон на учётной записи сотрудника. Поддерживаемый провайдер: MCN (FMC SIM). Все вызовы проходят через АТС, доступны запись и маршрутизация.

- Платный модуль. Провайдер: MCN.

Ссылка на руководство: [Документация MikoPBX — Подключение FMC устройств](https://docs.mikopbx.com/mikopbx/modules/miko/podklyuchenie-fms-ustroistv)

### Преимущества
- Звонки через GSM — связь есть даже без интернета
- Запись всех разговоров на АТС
- Возможна интеграция с CRM
- Полный контроль звонков средствами АТС (IVR, маршрутизация)

### Принцип работы
- SIM «регистрируется» на внутреннем номере сотрудника (например, `201`).
- Исходящий с SIM: в АТС видно, как вызов с внутреннего `201`.
- Входящий на `201`: вызов направляется на SIM сотрудника.

### Требования
- Рабочая MikoPBX
- Реквизиты транка MCN (FMC SIM)
- В карточке сотрудника указан мобильный номер в формате `+7...`

### Настройка
1) В карточке сотрудника укажите мобильный с кодом `+7` и во вкладке «Настройка маршрутизации» отключите переадресацию на мобильный.
2) Откройте «Подключение FMC устройств»:
   - Колонка «Исходящие звонки»: для «Логин» и «Пароль» нажмите «Обновить».
   - Колонка «Входящие звонки»: введите параметры подключения к транку MCN.
   - Поле «Сотрудники»: выберите всех пользователей с FMC SIM.
   - Поле «Провайдер FMC»: укажите MCN.
3) Сохраните. АТС выполнит регистрацию на транке MCN и на внутренних номерах сотрудников.

### Кастомизация (необязательно)
По умолчанию исходящие с SIM идут по стандартным маршрутам. Чтобы клиент видел номер SIM, добавьте в конец `extensions.conf`:

```conf
[outgoing-custom]
exten => _.X!,1,Set(FMC_ID=SIP-FMC-XXXXXX)
    ; Номер SIM использовать только для внутренних номеров из SIP-FMC-ENABLE-OUT
    same => n,ExecIf($["${DIALPLAN_EXISTS(SIP-FMC-ENABLE-OUT,${CALLERID(num)},1)}" != "1"]?return)
    ; При необходимости ограничить вызовами с SIM User-Agent
    ;same => n,ExecIf($["${PJSIP_HEADER(read,User-Agent)}" != "miko-b24-fmc" ]?return)
    same => n,GosubIf($["${DIALPLAN_EXISTS(all-outgoing-${FMC_ID}-custom,${EXTEN},1)}" == "1"]?all-outgoing-${FMC_ID}-custom,${EXTEN},1)
    same => n,return

[SIP-FMC-ENABLE-OUT]
exten => 201,1,NoOp(--- Out call ---)
exten => 202,1,NoOp(--- Out call ---)
```

- `SIP-FMC-XXXXXX` — логин из колонки «Исходящие звонки с FMC».

### Особенности транка MCN
По умолчанию «транк» MCN ограничен одним одновременным звонком. Рекомендуется увеличить лимит под ваши сценарии.

Примеры:
- Входящий на АТС ➜ SIM:
  - 1 линия: клиент ➜ MikoPBX
  - 1 линия: MikoPBX ➜ номер SIM

- Исходящий с SIM через другого провайдера:
  - 1 линия: SIM ➜ MikoPBX
  - 1 линия: MikoPBX ➜ сторонний провайдер ➜ клиент

- Исходящий с SIM, клиент видит номер SIM:
  - 1 линия: SIM ➜ MikoPBX
  - 1 линия: MikoPBX ➜ транк MCN ➜ клиент

- Входящий на публичный номер, распределяем на 3 SIM MCN:
  - 1 линия: клиент ➜ MikoPBX
  - 3 линии: MikoPBX ➜ три номера SIM

Источник: [Документация MikoPBX — Подключение FMC устройств](https://docs.mikopbx.com/mikopbx/modules/miko/podklyuchenie-fms-ustroistv)